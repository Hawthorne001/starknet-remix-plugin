FROM ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive
ENV DEBCONF_NONINTERACTIVE_SEEN=true

RUN apt-get update
RUN apt-get install -y curl \
                       git \
                       cmake \
                       build-essential \
                       gcc

WORKDIR /opt/app

# install Scarb
RUN curl --proto '=https' --tlsv1.2 -sSf https://docs.swmansion.com/scarb/install.sh | bash

# copy Remix plugin source and install Rust
COPY . /opt/app

RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain stable -y

RUN whoami

ENV PATH="/root/.cargo/bin:${PATH}"

RUN git submodule update --init

# Build the API service
WORKDIR /opt/app/api
RUN cargo build

# Build the cairo compiler
WORKDIR /opt/app/api/cairo
RUN cargo build --release --workspace

EXPOSE 8000

WORKDIR /opt/app/api
ENTRYPOINT [ "cargo", "run" ]
