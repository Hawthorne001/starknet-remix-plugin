FROM ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive
ENV DEBCONF_NONINTERACTIVE_SEEN=true

RUN apt-get update
RUN apt-get install -y curl \
                       git \
                       cmake \
                       build-essential \
                       gcc

WORKDIR /opt/app

# ensure we use bash for all RUN commands
# use -l to use interactive login shell
# and ensure modifications to bashrc are properly sourced
SHELL ["/bin/bash", "-c"]

# install asdf to manage all the thingz!!!
RUN git clone https://github.com/asdf-vm/asdf.git $HOME/.asdf --branch v0.13.1 && \
    echo ". $HOME/.asdf/asdf.sh" >> /root/.bashrc 
RUN source /root/.bashrc && \
    exec bash;

# install Scarb
RUN /bin/bash -c asdf plugin add scarb && \
    /bin/bash -c asdf list-all scarb && \
    /bin/bash -c asdf install scarb latest

# copy Remix plugin source and install Rust
COPY . /opt/app

RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --default-toolchain stable -y

RUN whoami

ENV PATH="/root/.cargo/bin:${PATH}"

RUN git submodule update --init

# Build the API service
WORKDIR /opt/app/api
RUN cargo build

# Build the cairo compiler
WORKDIR /opt/app/api/cairo
RUN cargo build --release --workspace

EXPOSE 8000

WORKDIR /opt/app/api
ENTRYPOINT [ "cargo", "run" ]
